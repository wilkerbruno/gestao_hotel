{% extends "base.html" %}

{% block title %}Reservas - SGHP{% endblock %}

{% block head %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .flatpickr-day.reservado {
            background-color: #ffcccc !important;
            color: #cc0000 !important;
            border: 2px solid #ff0000 !important;
            font-weight: bold;
        }
        .flatpickr-day.reservado:hover {
            background-color: #ff9999 !important;
        }
        #totalEstimado {
            background-color: #d4edda;
            color: #155724;
            font-weight: bold;
            padding: 10px;
            border-radius: 4px;
            font-size: 1.2em;
        }
        .form-check-input:checked {
            background-color: #198754;
        }
    </style>
{% endblock %}

{% block content %}
<h2><i class="fas fa-calendar-check"></i> Gest√£o de Reservas</h2>
<button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#modalReserva" onclick="limparModalReserva()">+ Nova Reserva</button>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>H√≥spede</th>
                <th>Pessoas (Crian√ßas)</th>
                <th>Refei√ß√µes</th>
                <th>Check-in</th>
                <th>Check-out</th>
                <th>Total (R$)</th>
                <th>Status</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for reserva in reservas %}
            <tr>
                <td><strong>{{ reserva.hospede_nome }}</strong></td>
                <td>{{ reserva.num_pessoas }} {% if reserva.num_criancas > 0 %}({{ reserva.num_criancas }} crian√ßa{{'s' if reserva.num_criancas > 1 else ''}}){% endif %}</td>
                <td>
                    {% if reserva.refeicoes %}
                        {% set refeicoes_list = reserva.refeicoes | from_json | list %}
                        <span class="badge bg-info">
                            {% for r in refeicoes_list %}
                                {{ r | replace('cafe', 'Caf√©') | replace('almoco', 'Almo√ßo') | replace('janta', 'Janta') }}{% if not loop.last %}<br>{% endif %}
                            {% endfor %}
                        </span>
                    {% else %}
                        <span class="badge bg-secondary">Sem Refei√ß√µes</span>
                    {% endif %}
                </td>
                <td>{{ reserva.data_checkin.strftime('%d/%m/%Y') }}</td>
                <td>{{ reserva.data_checkout.strftime('%d/%m/%Y') }}</td>
                <td><strong>R$ {{ "%.2f"|format(reserva.total) }}</strong></td>
                <td>
                    {% if reserva.status == 'Confirmada' %}
                        <span class="badge bg-info">Confirmada</span>
                    {% elif reserva.status == 'Check-in' %}
                        <span class="badge bg-warning text-dark">Check-in</span>
                    {% else %}
                        <span class="badge bg-success">Check-out</span>
                    {% endif %}
                </td>
                <td>
                    {% if reserva.status == 'Confirmada' %}
                    <form method="POST" style="display:inline;">
                        <input type="hidden" name="id" value="{{ reserva.id }}">
                        <button type="submit" name="checkin" class="btn btn-sm btn-warning" title="Fazer check-in">
                            <i class="fas fa-sign-in-alt"></i> Check-in
                        </button>
                    </form>
                    {% elif reserva.status == 'Check-in' %}
                    <form method="POST" style="display:inline;">
                        <input type="hidden" name="id" value="{{ reserva.id }}">
                        <button type="submit" name="checkout" class="btn btn-sm btn-success" title="Fazer check-out">
                            <i class="fas fa-sign-out-alt"></i> Check-out
                        </button>
                    </form>
                    {% endif %}
                    <form method="POST" style="display:inline;" onsubmit="return confirm('Tem certeza que deseja cancelar esta reserva?')">
                        <input type="hidden" name="id" value="{{ reserva.id }}">
                        <button type="submit" name="excluir" class="btn btn-sm btn-danger" title="Cancelar reserva">
                            <i class="fas fa-trash"></i> Cancelar
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% if not reservas %}
    <div class="alert alert-info mt-3">
        <i class="fas fa-info-circle"></i> Nenhuma reserva cadastrada. <a href="#" data-bs-toggle="modal" data-bs-target="#modalReserva" onclick="limparModalReserva()">Crie uma nova</a>.
    </div>
    {% endif %}
</div>

<!-- Modal para Nova Reserva -->
<div class="modal fade" id="modalReserva" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-plus"></i> Nova Reserva
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="formReserva" onsubmit="return validarReserva()">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label"><strong>Nome do H√≥spede</strong></label>
                        <input type="text" class="form-control" name="hospede" id="hospede" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label"><strong>N√∫mero de Pessoas</strong></label>
                            <input type="number" class="form-control" name="num_pessoas" id="num_pessoas" min="1" value="1" required onchange="atualizarTotal()">
                            <small class="text-muted">Total de h√≥spedes (adultos + crian√ßas)</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><strong>Crian√ßas</strong></label>
                            <input type="number" class="form-control" name="num_criancas" id="num_criancas" min="0" value="0" onchange="atualizarTotal()">
                            <small class="text-muted">N√∫mero de crian√ßas</small>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label"><strong>Check-in</strong></label>
                            <input type="date" name="data_checkin" id="data_checkin" class="form-control" required onchange="atualizarTotal()">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><strong>Check-out</strong></label>
                            <input type="date" name="data_checkout" id="data_checkout" class="form-control" required onchange="atualizarTotal()">
                        </div>
                    </div>

                    <hr>
                    
                    <label><strong>Refei√ß√µes</strong></label>
                    <p class="text-muted small">Selecione quais refei√ß√µes ser√£o inclu√≠das (valores por pessoa por dia):</p>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="refeicao" value="cafe" id="cafe" onchange="atualizarTotal()">
                        <label class="form-check-label" for="cafe">
                            ‚òï Caf√© da Manh√£ - <strong>R$ 20,00</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="refeicao" value="almoco" id="almoco" onchange="atualizarTotal()">
                        <label class="form-check-label" for="almoco">
                            üçΩÔ∏è Almo√ßo - <strong>R$ 30,00</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="refeicao" value="janta" id="janta" onchange="atualizarTotal()">
                        <label class="form-check-label" for="janta">
                            üåô Janta - <strong>R$ 25,00</strong>
                        </label>
                    </div>

                    <hr>
                    
                    <div class="alert alert-info">
                        <strong>C√°lculo:</strong>
                        <div id="detalhesCalculo" class="small mt-2" style="line-height: 1.8;">
                            <div>Hospedagem: <span id="valor_hospedagem">R$ 0,00</span></div>
                            <div>Refei√ß√µes: <span id="valor_refeicoes">R$ 0,00</span></div>
                            <hr style="margin: 0.5rem 0;">
                            <div id="totalEstimado">Total Estimado: R$ 0,00</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnSalvarReserva">
                        <i class="fas fa-save"></i> Salvar Reserva
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
const PRECOS_REFEICOES = {{ precos_refeicoes | tojson }};
const PRECO_ADULTO = 150.0;
const PRECO_CRIANCA = 80.0;

// Inicializar calend√°rios
document.addEventListener('DOMContentLoaded', function() {
    const checkinInput = document.getElementById('data_checkin');
    const checkoutInput = document.getElementById('data_checkout');
    const datosReservados = {{ datas_reservadas | tojson }};
    
    // Plugin customizado para colorir datas reservadas
    const disableDatesPlugin = function(fp) {
        return {
            onReady: function() {
                const diasReservados = [];
                datosReservados.forEach(res => {
                    let data = new Date(res.checkin);
                    while (data < new Date(res.checkout)) {
                        diasReservados.push(new Date(data));
                        data.setDate(data.getDate() + 1);
                    }
                });
                
                fp.days.querySelectorAll('.flatpickr-day').forEach(day => {
                    const date = new Date(day.dateObj);
                    if (diasReservados.some(d => d.toDateString() === date.toDateString())) {
                        day.classList.add('reservado');
                        day.style.pointerEvents = 'none';
                    }
                });
            }
        };
    };
    
    flatpickr(checkinInput, {
        minDate: 'today',
        dateFormat: 'Y-m-d',
        plugins: [disableDatesPlugin(this)]
    });
    
    flatpickr(checkoutInput, {
        minDate: 'today',
        dateFormat: 'Y-m-d',
        plugins: [disableDatesPlugin(this)]
    });
});

function limparModalReserva() {
    document.getElementById('formReserva').reset();
    document.getElementById('totalEstimado').textContent = 'Total Estimado: R$ 0,00';
    document.getElementById('valor_hospedagem').textContent = 'R$ 0,00';
    document.getElementById('valor_refeicoes').textContent = 'R$ 0,00';
}

function atualizarTotal() {
    const numPessoas = parseInt(document.getElementById('num_pessoas').value) || 0;
    const numCriancas = parseInt(document.getElementById('num_criancas').value) || 0;
    const dataCheckin = document.getElementById('data_checkin').value;
    const dataCheckout = document.getElementById('data_checkout').value;
    
    if (!dataCheckin || !dataCheckout || numPessoas === 0) return;
    
    // Calcular di√°rias
    const checkin = new Date(dataCheckin);
    const checkout = new Date(dataCheckout);
    const dias = Math.ceil((checkout - checkin) / (1000 * 60 * 60 * 24));
    
    if (dias <= 0) return;
    
    // Calcular hospedagem
    const adultos = numPessoas - numCriancas;
    const valorHospedagem = dias * (adultos * PRECO_ADULTO + numCriancas * PRECO_CRIANCA);
    
    // Calcular refei√ß√µes
    const refeicoesSelecionadas = Array.from(document.querySelectorAll('input[name="refeicao"]:checked'))
        .map(el => el.value);
    
    let valorRefeicoes = 0;
    if (refeicoesSelecionadas.length > 0) {
        const custoPorDia = refeicoesSelecionadas.reduce((sum, tipo) => sum + (PRECOS_REFEICOES[tipo] || 0), 0);
        valorRefeicoes = dias * custoPorDia * numPessoas;
    }
    
    const total = valorHospedagem + valorRefeicoes;
    
    // Atualizar display
    document.getElementById('valor_hospedagem').textContent = 'R$ ' + valorHospedagem.toFixed(2).replace('.', ',');
    document.getElementById('valor_refeicoes').textContent = 'R$ ' + valorRefeicoes.toFixed(2).replace('.', ',');
    document.getElementById('totalEstimado').textContent = 'Total Estimado: R$ ' + total.toFixed(2).replace('.', ',');
}

function validarReserva() {
    const numPessoas = parseInt(document.getElementById('num_pessoas').value);
    const numCriancas = parseInt(document.getElementById('num_criancas').value);
    
    if (numCriancas > numPessoas) {
        alert('N√∫mero de crian√ßas n√£o pode exceder o total de pessoas!');
        return false;
    }
    
    const dataCheckin = document.getElementById('data_checkin').value;
    const dataCheckout = document.getElementById('data_checkout').value;
    if (new Date(dataCheckin) >= new Date(dataCheckout)) {
        alert('Data de check-out deve ser posterior ao check-in!');
        return false;
    }
    
    // Serializar refei√ß√µes como JSON
    const refeicoes = Array.from(document.querySelectorAll('input[name="refeicao"]:checked'))
        .map(el => el.value);
    
    // Criar input hidden com JSON
    let refeicoesInput = document.getElementById('refeicoes_json');
    if (!refeicoesInput) {
        refeicoesInput = document.createElement('input');
        refeicoesInput.type = 'hidden';
        refeicoesInput.id = 'refeicoes_json';
        refeicoesInput.name = 'refeicoes';
        document.getElementById('formReserva').appendChild(refeicoesInput);
    }
    refeicoesInput.value = JSON.stringify(refeicoes);
    
    return true;
}
</script>
{% endblock %}