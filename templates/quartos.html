{% extends "base.html" %}

{% block title %}Quartos - SGHP{% endblock %}

{% block content %}
<h2><i class="fas fa-bed"></i> Gestão de Quartos</h2>
<button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#modalQuarto" onclick="limparModal()">+ Novo Quarto</button>

<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Número</th>
                <th>Tipo</th>
                <th>Preço/Diária (R$)</th>
                <th>Status</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for q in quartos %}
            <tr>
                <td>{{ q.numero }}</td>
                <td>{{ q.tipo }}</td>
                <td>{{ "%.2f"|format(q.preco_diaria) }}</td>
                <td>
                    <span class="badge {% if q.status == 'Disponivel' %}bg-success{% elif q.status == 'Ocupado' %}bg-danger{% else %}bg-warning{% endif %}">
                        {{ q.status }}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="editarQuarto({{ q.id }}, '{{ q.numero }}', '{{ q.tipo }}', {{ q.preco_diaria }}, '{{ q.status }}')">Editar</button>
                    <form method="POST" style="display:inline;" onsubmit="return confirm('Excluir quarto? Isso cancelará reservas associadas!')">
                        <input type="hidden" name="id" value="{{ q.id }}">
                        <button type="submit" name="excluir" class="btn btn-sm btn-danger">Excluir</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal para Novo/Editar Quarto -->
<div class="modal fade" id="modalQuarto" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">Novo Quarto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="formQuarto">
                <div class="modal-body">
                    <input type="hidden" name="id" id="quartoId">
                    <div class="mb-3">
                        <label class="form-label">Número</label>
                        <input type="text" class="form-control" name="numero" id="numero" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo</label>
                        <select class="form-select" name="tipo" id="tipo" required>
                            <option value="Single">Single</option>
                            <option value="Duplo">Duplo</option>
                            <option value="Suíte">Suíte</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Preço Diária (R$)</label>
                        <input type="number" class="form-control" name="preco" id="preco" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status" id="status">
                            <option value="Disponivel">Disponível</option>
                            <option value="Ocupado">Ocupado</option>
                            <option value="Manutencao">Manutenção</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnSalvar">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Função para limpar modal (novo quarto)
    function limparModal() {
        document.getElementById('formQuarto').reset();
        document.getElementById('quartoId').value = '';
        document.getElementById('modalTitle').textContent = 'Novo Quarto';
        document.getElementById('btnSalvar').textContent = 'Salvar';
    }

    // Editar Quarto (preenche modal)
    function editarQuarto(id, numero, tipo, preco, status) {
        document.getElementById('quartoId').value = id;
        document.getElementById('numero').value = numero;
        document.getElementById('tipo').value = tipo;
        document.getElementById('preco').value = preco.toFixed(2);
        document.getElementById('status').value = status;
        document.getElementById('modalTitle').textContent = 'Editar Quarto';
        document.getElementById('btnSalvar').textContent = 'Atualizar';
        new bootstrap.Modal(document.getElementById('modalQuarto')).show();
    }

    // Validação antes de submit
    document.getElementById('formQuarto').addEventListener('submit', function(e) {
        const id = document.getElementById('quartoId').value;
        const numero = document.getElementById('numero').value.trim();
        if (!numero) {
            e.preventDefault();
            alert('Número do quarto é obrigatório!');
            return false;
        }
        if (!id && document.querySelector('input[name="numero"]').value) {
            // Para novo, verifica se já existe (simples, via JS; backend valida também)
            const existing = document.querySelectorAll('td:first-child');
            for (let td of existing) {
                if (td.textContent.trim() === numero) {
                    alert('Número de quarto já existe!');
                    e.preventDefault();
                    return false;
                }
            }
        }
    });
</script>
{% endblock %}